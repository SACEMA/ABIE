---
title: "Recent Infection Test Calibration (estimating MDRI and FRR)"
author: "Eduard Grebe"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TestCalibration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Integrating TCGA Data}
---

This vignette covers the use of functions $mdri_ml_binomial$ and $frr_binomial$. 

**Note - this is an outline from the example file previously provided. It needs substantial work.**

## mdri_ml_binomial()

Load the package in order to use it

```{r}
library(abie)
```

```{r}
exampledata <- read.csv("../data/exampledata_testcalibration.csv")
```

In the following example, subject (panel) identifier and time since estimated date of infection
is provided. Then a list of "functional forms" - this parameter can be left out since the default is
to use both.
The next two paramters are the recency cutoff time aka "Big T" (we usually suggest 2 years) and the
data exclusion rule, i.e. all data points beyond this time are ignored in the fitting procedure.
The "recency rule" is to tell the function how to distinguish recent from non-recent results. You
can classify the data yourself and use "binary_data" as the rule, and then specify the variable in
your data frame.
We are also specifying a vector of variables and a vector of paramaters to define recency
In this case we are using the assay result and the viral load. The paramaters 10,0,1000,1 mean
that recency is defined as a biomarker reading below 10 and a viral load reading above 1000
alpha and n_bootstraps relate to obtaining confidence intervals using subject-level bootstrapping.

In the following two examples, only 1,000 bootstrap resamples are taken. We recommend 10,000 for accurate confidence intervals.

Here we will use the complementary log-log link $\ln(t)$ as predictor to model $P_R(t)$:

```{r, fig.width=6.5, fig.height=5, fig.align="center"}
mdri_ml_binomial(data=exampledata,
                 subid_var = "SubjectID",
                 time_var = "DaysSinceEDDI",
                 recency_cutoff_time = 730.5,
                 inclusion_time_threshold = 800,
                 functional_forms = c("cloglog_linear"),
                 recency_rule = "independent_thresholds",
                 recency_vars = c("Result","VL"),
                 recency_params = c(10,0,1000,1),
                 n_bootstraps = 100,
                 alpha = 0.05,
                 plot = TRUE)
```

Here we use the logit link and a cubic polynomial in $t$ to model $P_R(t)$:

```{r, fig.width=6.5, fig.height=5, fig.align="center"}
mdri_ml_binomial(data=exampledata,
                 subid_var = "SubjectID",
                 time_var = "DaysSinceEDDI",
                 recency_cutoff_time = 730.5,
                 inclusion_time_threshold = 800,
                 functional_forms = c("logit_cubic"),
                 recency_rule = "independent_thresholds",
                 recency_vars = c("Result","VL"),
                 recency_params = c(10,0,1000,1),
                 n_bootstraps = 100,
                 alpha = 0.05,
                 plot = TRUE)
```

As above, but parellelise the bootstrapping. In this case, split the job over four cores.

**Note: This only works on Unix (Mac or Linux). On Windows this will result in error messages.**

```{r, fig.width=7, fig.height=5, fig.align="center"}
mdri_ml_binomial(data=exampledata,
                 subid_var = "SubjectID",
                 time_var = "DaysSinceEDDI",
                 recency_cutoff_time = 730.5,
                 inclusion_time_threshold = 800,
                 functional_forms = c("logit_cubic","cloglog_linear"),
                 recency_rule = "independent_thresholds",
                 recency_vars = c("Result","VL"),
                 recency_params = c(10,0,1000,1),
                 n_bootstraps = 1000,
                 alpha = 0.05,
                 plot = TRUE,
                 parallel = TRUE,
                 cores=4)
```
## frr_binomial()

This example calculates a false-recent rate, treating the data at subject level

```{r}
frr_binomial(data=exampledata,
             subid_var = "SubjectID",
             time_var = "DaysSinceEDDI",
             recency_cutoff_time = 730.5,
             recency_rule = "independent_thresholds",
             recency_vars = c("Result","VL"),
             recency_params = c(10,0,1000,1),
             alpha = 0.05)
```

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output:
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side.

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
