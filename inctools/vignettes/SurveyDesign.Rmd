---
title: "Survey design: power, precision and sample size"
date: 2016-05-12
output: rmarkdown::html_vignette
#output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Survey design}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette covers the use of functions `incpower` and `incprecision`.

## Function `incpower`

For this related set of calculations, we use the term "power" to mean the probability of obtaining a "statistically significant" result, *of the correct sign* in the estimation of an incidence difference, given some assumptions on effect size, recency test properties, and sample specification. See the vignette "introduction", especially the glossary, for some crucial details.

Function `incpower` primarily calculates samples sizes required to achieve desired power, or the power available at specified sample size(s).
This requires study context defining parameter values--such as hypothetical incidence rates, prevalences, coverage rates, design effects, and the assay characteristics known as *mean duration of recent infection* (MDRI) and *false recent rate* (FRR)--and returns .

A number of supplementary outputs are also supplied, such as

* demonstrative relative standard errors and confidence limits, in the case that point estimates attain the true/expected values.  
* expected survey counts, assuming a non structured sampling frame.

### Examples

Consider calculating the power to infer the correct ordering of an incidence of 5\% and one of 3\%, at a shared prevalences of 20\%, given a single set of recency test property estimates i.e. one value for each of MDRI, the RSE of MDRI, FRR, the RSE of FRR, and time cutoff T namely, in order: 200 days, 5\%, 1\%, 20\%, and 730 days. Assume complete coverage of recency status ascertainment, and no survey design effects. Finally, envision a common study sample size of 5000 persons and set $\alpha$ to 5\%. That power, as opposed to sample size (the default) is the desired output, is captured in the specification of the argument `Power = "out"` and `SS = NULL`.


```{r, echo=FALSE}
library("inctools")
```


```{r, echo=TRUE}
incpower(I1 = 0.05, I2 = 0.03, PrevH1 = 0.20, PrevH2 = 0.20, n1 = 5000,
        n2 = 5000, alpha = 0.05,Power = "out", SS = NULL, CR = 1, DE_H = 1,
        DE_R = 1, BMest = "same.test", MDRI = 200, RSE_MDRI = 0.05, FRR = 0.01,
        RSE_FRR = 0.20, BigT = 730)
```

Here the output returns that the power of this particular test is 0.858. In the limit of infinite sample size power approaches one.

For the benefit of survey planning (such as costing) the returned `Implied.Subject.Counts` object captures demonstrative survey counts in the case that expectation values are precisely attained.

To calculate the required (common) sample size for two surveys, to obtain a desired power:

* omit `n1` and `n2` or set both to `"both"`
* set `SS = "out"`
* set `Power` to the desired value.


```{r, echo=TRUE}
incpower(I1 = 0.05, I2 = 0.03, PrevH1 = 0.20, PrevH2 = 0.15, alpha = 0.05,
        Power = 0.8, SS = "out", CR = 1, DE_H = 1, DE_R = 1,
        BMest = "FRR.indep", MDRI = 200, RSE_MDRI = 0.05, FRR = c(0.01,0.009),
        RSE_FRR = c(0.20,0.22), BigT = 730)
```

The function call outputs that the necessary common study sample size is 4122 persons per study to achieve the desired 80\% power given the specified population parameters and assay characteristics.



## Function `incprecision`

This function summarizes performance of a recent infection test into a standard error of the incidence estimate, given the estimated test properties and hypothetical survey context or the sample size necessary for a given level of precision. 

Up to two arguments can be specified as tuples, with the input parameter `step` specifying the number of points analyzed between the endpoints of the given tuple. This specification will yield output for each value in the step for the output parameters that take as argument one of the varying inputs. See the second and third example below for an illustration of this output.

### Examples

The function call below returns the necessary sample size to have RSE of the incidence estimator equal to 25\%, given a hypothetical prevalence, coverage rate, and assay tests parameter estimates. Note here the design effects for the test of HIV positivity are set to 1.1 and that sample size is set to `n = "out"`.

```{r, echo=TRUE}
incprecision(I = 0.015, RSE_I = 0.25, PrevH = 0.2, CR = 1, MDRI = 200,
            RSE_MDRI = 0.05, FRR = 0.01, RSE_FRR = 0.2, BigT = 730,
            DE_H = 1.1, DE_R = 1, n = 'out')
```

The function call returns that the necessary sample size for the desired precision in the incidence estimator is 3634 persons. Prevalence of being HIV positive and recently infected is 0.8\%, prevalence of being HIV positive and nonrecently infected is 19\%. The RSE of the incidence estimator at infinite sample size is 7.6\%, and the RSE of prevalence of positivity for HIV is 3.4\% and the RSE of prevalence of recency is 3.55\%.



Next consider the function call for a tuple of prevalence of HIV positivity values and incidence estimates that range in value between 10 and 20\% and 1.5 and 2\% respectively. The function now outputs a range of values 3 values for each output parameter that is dependent upon these two varying quantities, as well as the normal output from a single parameter function call when the output does not depend on the varying parameters. Note again that sample size is set to `n = "out"`.

```{r, echo=TRUE}
incprecision(I = c(0.015,0.02), RSE_I = 0.25, PrevH = c(0.10,0.20), CR = 1,
             MDRI = 200, RSE_MDRI = 0.05, FRR = 0.01, RSE_FRR = 0.2, BigT = 700,
             DE_H = 1, DE_R = 1, n = 'out', step = 3)
```

So for example in the first listed output, the sample size necessary for a given precision in the incidence estimator, the output shows that for hypothetical values of PrevH = 0.15 and I = 0.0175, midway in the step between 10 and 20\% and 1.5 and 2\% respectively, the necessary sample size for RSE_I = 0.25 is 2547 persons enrolled.


Finally, for calculating the RSE of incidence over a range of 5 values of prevalence of positivity with a sample size of 5000, the user will set the sample size parameter to a given value, here `n = 5000`. The precision is set to output with option  `RSE_I = "out"`.

```{r, echo=TRUE}
incprecision(I = 0.017, RSE_I = 'out', PrevH = c(0.10,0.20), CR = 1, MDRI = 211,
             RSE_MDRI = 0.05, FRR = 0.009, RSE_FRR = 0.2, BigT = 720, n = 5000,
             step = 5)
```

<!-- #not-for-release -->
<!--
If one study has already been completed, one may calculate sample size requirements for a second survey, to obtain desired power:

* `n1` is set to the sample size of the completed  The function call for this situation is similar to the previous call, except the survey for which the sample size generation is to be performed will have the sample size parameter in the function call specified as `"out`. See below for an example of this syntax and output. Again, note that the function parameter for sample size is still set to `SS = "out"`.

```{r, echo=TRUE}
incpower(I1 = 0.05, I2 = 0.03, PrevH1 = 0.20, PrevH2 = 0.15, n1 = 5000,
        n2 = "out", alpha = 0.05, Power = 0.8, SS = "out", CR = 1, DE_H = 1,
        DE_R = 1, BMest = "same.test", MDRI = 200, RSE_MDRI = 0.05, FRR = 0.01,
        RSE_FRR = 0.21, BigT = 730)
```
The function now returns the necessary sample size for survey 2 that will generate power of 80\%, given the hypothetical population parameters for survey 2 and the observed parameter estimates for survey 1 and the assay characteristics MDRI, FRR, and their respective relative standard errors and time cut point T.

-->
