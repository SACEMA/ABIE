---
title: "Recent Infection Test Calibration (Estimating MDRI and FRR)"
author: "Eduard Grebe"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TestCalibration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Integrating TCGA Data}
---

This vignette covers the use of functions $mdrical$ and $frrcal$. 

## Introduction

Incidence estimates from cross-sectional surveys using biomarkers for 'recent infection' require that the test for recent infection (usually an adapted diagnostic assay) be accurately characterised (which we term calibration). The two critical parameters of test performance are the Mean Duration of Recent Infection (MDRI), denoted $\Omega_T$, (with $T$ the recency cutoff time), and False Recent Rate (FRR), denoted $\Beta_T$. The explicit time cutoff $T$ was introduced by Kassanjee et al. $Epidemiology$, 2012.[^1] to differentiate between 'true recent' and 'false recent' results. They state:

>To lead to an informative estimator, this cut-off, though theoretically arbitrary, must be chosen to reflect the temporal dynamic range of the test for recent infection; i.e. at a time T post infection, the overwhelming majority of infected people should no longer be testing “recent”, and furthermore, T should not be larger than necessary to achieve this criterion.[^1]

MDRI $\Omega_T$ is defined as the average time alive and returning a ‘recent’ result, while infected for times less than $T$. FRR $\Beta_T$ is defined as the proportion of subjects returning a 'recent' result while infected for longer than $T$.

Test performance may be context-specific, and therefore, where available, local data should be used to calibrate tests. However, should published estimates be used, these may need to be adapted to the local context. Often cross-sectional incidence surveys incorporate recency testing using a Recent Infection Testing Algorithms (RITAs) and it is important to realise that the entire RITA must be appropriately calibrated. This may involve adapting MDRI estimates for more sensitive screening tests (depending on the case definition of 'recent'), or adapting FRR estimates based on weighted estimates from specimen subsets appropriate to the local population (e.g. large numbers of treated individuals). Where possible calibration should be performed using the same set of biomarkers used in a RITA, such as by including a viral load threshold in the calibration step.

## Estimating MDRI using binomial regression

This package provides the function $mdrical$ to estimate MDRI for a given biomarker or set of biomarkers from a dataset of based on the test being applied to well-characterised specimens and subjects. That is, time since 'infection' should be well-known, as well as test result(s). Note that 'infection' can be arbitrarily defined as the reference time (e.g. the exposure event, date of first detectability on an RNA assay, Western Blot seroconversion, etc.) but should be consistently used. If the reference time used in test calibration differs from the screening assay or algorithm that is used define someone as HIV-positive in a RITA, MDRI needs to be appropriately adapted to cater for this difference. 

The following uses example data to demonstrate the use of the function $mdrical$.

Load the package in order to use it

```{r}
library(abie)
```

```{r}
exampledata <- read.csv("../data/exampledata_testcalibration.csv")
```

In the following example, subject (panel) identifier and time since estimated date of infection
is provided. Then a list of "functional forms" - this parameter can be left out since the default is
to use both.
The next two paramters are the recency cutoff time aka "Big T" (we usually suggest 2 years) and the
data exclusion rule, i.e. all data points beyond this time are ignored in the fitting procedure.
The "recency rule" is to tell the function how to distinguish recent from non-recent results. You
can classify the data yourself and use "binary_data" as the rule, and then specify the variable in
your data frame.
We are also specifying a vector of variables and a vector of paramaters to define recency
In this case we are using the assay result and the viral load. The paramaters 10,0,1000,1 mean
that recency is defined as a biomarker reading below 10 and a viral load reading above 1000
alpha and n_bootstraps relate to obtaining confidence intervals using subject-level bootstrapping.

In the following two examples, only 1,000 bootstrap resamples are taken. We recommend 10,000 for accurate confidence intervals.

Here we will use the complementary log-log link $\ln(t)$ as predictor to model $P_R(t)$:

```{r, fig.width=6.5, fig.height=5, fig.align="center"}
mdrical(data=exampledata,
                 subid_var = "SubjectID",
                 time_var = "DaysSinceEDDI",
                 recency_cutoff_time = 730.5,
                 inclusion_time_threshold = 800,
                 functional_forms = c("cloglog_linear"),
                 recency_rule = "independent_thresholds",
                 recency_vars = c("Result","VL"),
                 recency_params = c(10,0,1000,1),
                 n_bootstraps = 100,
                 alpha = 0.05,
                 plot = TRUE)
```

Here we use the logit link and a cubic polynomial in $t$ to model $P_R(t)$:

```{r, fig.width=6.5, fig.height=5, fig.align="center"}
mdrical(data=exampledata,
                 subid_var = "SubjectID",
                 time_var = "DaysSinceEDDI",
                 recency_cutoff_time = 730.5,
                 inclusion_time_threshold = 800,
                 functional_forms = c("logit_cubic"),
                 recency_rule = "independent_thresholds",
                 recency_vars = c("Result","VL"),
                 recency_params = c(10,0,1000,1),
                 n_bootstraps = 100,
                 alpha = 0.05,
                 plot = TRUE)
```

As above, but parellelise the bootstrapping. In this case, split the job over four cores.

**Note: This only works on Unix (Mac or Linux). On Windows this will result in error messages.**

```{r, fig.width=7, fig.height=5, fig.align="center"}
mdrical(data=exampledata,
                 subid_var = "SubjectID",
                 time_var = "DaysSinceEDDI",
                 recency_cutoff_time = 730.5,
                 inclusion_time_threshold = 800,
                 functional_forms = c("logit_cubic","cloglog_linear"),
                 recency_rule = "independent_thresholds",
                 recency_vars = c("Result","VL"),
                 recency_params = c(10,0,1000,1),
                 n_bootstraps = 1000,
                 alpha = 0.05,
                 plot = TRUE,
                 parallel = TRUE,
                 cores=4)
```
## frr_binomial()

This example calculates a false-recent rate, treating the data at subject level

```{r}
frrcal(data=exampledata,
             subid_var = "SubjectID",
             time_var = "DaysSinceEDDI",
             recency_cutoff_time = 730.5,
             recency_rule = "independent_thresholds",
             recency_vars = c("Result","VL"),
             recency_params = c(10,0,1000,1),
             alpha = 0.05)
```

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output:
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side.

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))

[^1]: Kassanjee, Reshma, et al. "A new general biomarker-based incidence estimator." Epidemiology (Cambridge, Mass.) 23.5 (2012): 721. [URL](http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3500970/)
